<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目 "xx" - API 测试页面 (完整功能 v7)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 700px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .page-header { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;}
        .page-header h1 { margin: 0; font-size: 1.8em; }
        h2, h3, h4 { border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="password"], input[type="date"], input[type="number"], select { width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { width: calc(100% - 22px); padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; min-height: 80px;}
        button { padding: 10px 15px; margin-top: 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #218838; }
        button.delete { background-color: #dc3545; }
        button.delete:hover { background-color: #c82333; }
        button.action { background-color: #ffc107; color: #212529;} /* Yellow for action */
        button.action:hover { background-color: #e0a800; }
        button.info { background-color: #17a2b8; } /* Blue for info/export/list */
        button.info:hover { background-color: #138496; }
        button.warning { background-color: #fd7e14; } /* Orange for password changes/restore */
        button.warning:hover { background-color: #e66800; }
        button.danger { background-color: #6c757d; color: white;} /* Dark grey for backup */
        button.danger:hover { background-color: #5a6268;}
        pre { background-color: #f4f4f4; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; margin-top: 10px;}
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #f9f9f9;}
        .token-section { background-color: #fffacd; }
        .admin-section { background-color: #ffebee; } /* Light red for admin only sections */
        .form-group { margin-bottom: 15px; }
        .inline-form-group { display: inline-block; margin-right: 10px; vertical-align: top; }
        .inline-form-group label, .inline-form-group input, .inline-form-group select { width: auto; /* Adjust as needed */ }
        #customDestinationGroup, #adminUserSummaryMonthGroup, #adminUserSummaryWeekGroup, #customAmountGroup { display: none; } /* Initially hidden */
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header"> <h1>项目 "xx" - API 测试页面</h1>
        </div>
        
        <div class="section token-section">
            <h3>身份认证 Token</h3>
            <div class="form-group">
                <label for="authToken">JWT Token:</label>
                <textarea id="authToken" placeholder="从登录接口获取到的 Token 粘贴到这里"></textarea>
                <small>请先通过认证测试页面登录并复制 Token。管理员功能需要管理员 Token。</small>
            </div>
        </div>

        <div class="section">
            <h2>添加收入记录</h2>
            <div class="form-group">
                <label for="entryDate">日期:</label>
                <input type="date" id="entryDate">
            </div>
            <div class="form-group">
                <label for="destination">目的地:</label>
                <select id="destination" onchange="handleDestinationChange()">
                    <option value="ONT8">ONT8</option>
                    <option value="LBG8">LBG8</option>
                    <option value="SBD1">SBD1</option>
                    <option value="LAX9">LAX9</option>
                    <option value="IUSP">IUSP</option>
                    <option value="XLX7">XLX7</option>
                    <option value="IUSJ">IUSJ</option>
                    <option value="POC1">POC1</option>
                    <option value="POC3">POC3</option>
                    <option value="LOCAL">LOCAL</option>
                    <option value="油">油</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="form-group" id="customDestinationGroup">
                <label for="customDestination">自定义目的地名称:</label>
                <input type="text" id="customDestination" placeholder="输入其他目的地">
            </div>
            <div class="form-group">
                <label for="amountType">金额:</label>
                <select id="amountType" onchange="toggleCustomAmountInput()">
                    <option value="100">100</option>
                    <option value="150">150</option>
                    <option value="200">200</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="form-group" id="customAmountGroup">
                <label for="customAmount">其他金额:</label>
                <input type="number" id="customAmount" placeholder="输入其他金额 (强制数字)">
            </div>
            <div class="form-group">
                <input type="checkbox" id="isOilExpense" style="width: auto; margin-right: 5px;">
                <label for="isOilExpense" style="display: inline; font-weight: normal;">这是一条油费记录</label>
            </div>
            <button onclick="addIncome()">添加收入</button>
        </div>

        <div class="section">
            <h2>获取未结算的收入列表</h2>
            <button onclick="getUnsettledIncome()">获取列表</button>
        </div>

        <div class="section">
            <h2>执行结算操作</h2>
            <p>这将把当前用户所有未结算的收入记录进行汇总结算。</p>
            <button onclick="executeSettlement()" class="action">执行结算</button>
        </div>
        
        <div class="section">
            <h2>导出结算详情 (Excel)</h2>
            <div class="form-group">
                <label for="settlementIdToExport">要导出的结算记录 ID:</label>
                <input type="number" id="settlementIdToExport" placeholder="输入结算记录的 ID">
            </div>
            <button onclick="exportSettlementExcel()" class="info">导出结算详情 (Excel)</button>
        </div>

        <div class="section">
            <h2>用户修改自己的密码</h2>
            <div class="form-group">
                <label for="currentPassword">当前密码:</label>
                <input type="password" id="currentPassword" placeholder="输入当前密码">
            </div>
            <div class="form-group">
                <label for="newPasswordUser">新密码:</label>
                <input type="password" id="newPasswordUser" placeholder="输入新密码">
            </div>
            <button onclick="changeMyPassword()" class="warning">修改我的密码</button>
        </div>

        <div class="section admin-section">
            <h2>管理员功能区</h2>
            <p style="color: red; font-weight: bold;">以下功能需要使用管理员账户的 Token！</p>

            <h4>管理员获取用户列表</h4>
            <button onclick="adminGetUserList()" class="info">获取所有用户列表</button>
            <hr style="margin: 20px 0;">

            <h4>管理员查看用户收入统计</h4>
            <div class="form-group">
                <label for="adminTargetUserIdSummary">目标用户 ID:</label>
                <input type="number" id="adminTargetUserIdSummary" placeholder="输入用户ID">
            </div>
            <div class="form-group">
                <label for="adminPeriodType">统计周期:</label>
                <select id="adminPeriodType" onchange="toggleAdminSummaryPeriodInputs()">
                    <option value="yearly">年度 (Yearly)</option>
                    <option value="monthly">月度 (Monthly)</option>
                    <option value="weekly">周度 (Weekly)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="adminSummaryYear">年份 (YYYY):</label>
                <input type="number" id="adminSummaryYear" placeholder="例如: 2025" value="2025">
            </div>
            <div class="form-group" id="adminUserSummaryMonthGroup">
                <label for="adminSummaryMonth">月份 (1-12):</label>
                <input type="number" id="adminSummaryMonth" placeholder="例如: 5">
            </div>
            <div class="form-group" id="adminUserSummaryWeekGroup">
                <label for="adminSummaryWeek">周数 (0-53):</label>
                <input type="number" id="adminSummaryWeek" placeholder="例如: 22">
            </div>
            <button onclick="adminGetUserIncomeSummary()" class="info">获取用户收入统计</button>
            <hr style="margin: 20px 0;">


            <h4>管理员修改用户密码</h4>
            <div class="form-group">
                <label for="targetUserId">目标用户 ID:</label>
                <input type="number" id="targetUserId" placeholder="输入要修改密码的用户ID">
            </div>
            <div class="form-group">
                <label for="newPasswordAdmin">为用户设置的新密码:</label>
                <input type="password" id="newPasswordAdmin" placeholder="输入新密码">
            </div>
            <button onclick="adminChangeUserPassword()" class="warning">管理员修改用户密码</button>
            <hr style="margin: 20px 0;">

            <h4>数据库备份与恢复</h4>
            <div class="form-group">
                <button onclick="adminBackupDatabase()" class="danger">创建数据库备份</button>
            </div>
            <div class="form-group">
                <button onclick="adminListBackups()" class="info">列出可用备份</button>
            </div>
            <div class="form-group">
                <label for="backupFilenameToRestore">要恢复的备份文件名:</label>
                <input type="text" id="backupFilenameToRestore" placeholder="从列表选择或输入备份文件名">
            </div>
            <button onclick="adminRestoreDatabase()" class="warning">从备份恢复数据库</button>
            <p style="color: red;">恢复数据库后，强烈建议重启后端服务器！</p>
        </div>


        <div class="section">
            <h2>删除收入记录</h2>
            <div class="form-group">
                <label for="incomeIdToDelete">要删除的收入记录 ID:</label>
                <input type="number" id="incomeIdToDelete" placeholder="输入收入记录的 ID">
            </div>
            <button onclick="deleteIncomeEntry()" class="delete">删除记录</button>
        </div>

        <h2>API 响应:</h2>
        <pre id="responseOutput">这里将显示服务器的响应...</pre>
    </div>

    <script>
        const API_BASE_URL_INCOME = 'http://localhost:8000/api/income';
        const API_BASE_URL_SETTLEMENTS = 'http://localhost:8000/api/settlements';
        const API_BASE_URL_AUTH = 'http://localhost:8000/api/auth'; 
        const API_BASE_URL_ADMIN = 'http://localhost:8000/api/admin'; 
        const outputDiv = document.getElementById('responseOutput');

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            // Initial setup for destination and amount
            handleDestinationChange(); 
            toggleAdminSummaryPeriodInputs(); 
        });

        function checkCustomDestination() {
            const destinationSelect = document.getElementById('destination');
            const customGroup = document.getElementById('customDestinationGroup');
            if (destinationSelect.value === '其他') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
                document.getElementById('customDestination').value = '';
            }
        }

        function toggleCustomAmountInput() {
            const amountTypeSelect = document.getElementById('amountType');
            const customAmountGroup = document.getElementById('customAmountGroup');
            if (amountTypeSelect.value === '其他') {
                customAmountGroup.style.display = 'block';
                document.getElementById('customAmount').focus();
            } else {
                customAmountGroup.style.display = 'none';
                document.getElementById('customAmount').value = '';
            }
        }

        function handleDestinationChange() {
            checkCustomDestination(); // Handle custom destination input visibility

            const destination = document.getElementById('destination').value;
            const amountTypeSelect = document.getElementById('amountType');
            const customAmountInput = document.getElementById('customAmount');
            
            const destinationsFor200 = ["ONT8", "LBG8", "SBD1", "LAX9", "IUSP", "XLX7", "IUSJ", "POC1", "POC3"];

            if (destinationsFor200.includes(destination)) {
                amountTypeSelect.value = "200";
            } else if (destination === "LOCAL") {
                amountTypeSelect.value = "100";
            } else if (destination === "油" || destination === "其他") {
                amountTypeSelect.value = "其他";
            } else {
                // Default or for unhandled destinations, maybe keep current or set to "其他"
                // For now, let's default to "其他" if no specific rule applies
                amountTypeSelect.value = "其他";
            }
            toggleCustomAmountInput(); // Update visibility of custom amount input based on new amountType
        }


        function getAuthToken() {
            const token = document.getElementById('authToken').value;
            if (!token) {
                alert('请先粘贴有效的 JWT Token！');
                return null;
            }
            return token.startsWith('Bearer ') ? token : `Bearer ${token}`;
        }

        async function addIncome() {
            const token = getAuthToken();
            if (!token) return;

            const entry_date = document.getElementById('entryDate').value;
            const destination = document.getElementById('destination').value;
            const custom_destination = document.getElementById('customDestination').value;
            const is_oil_expense = document.getElementById('isOilExpense').checked;

            let amount;
            const amountTypeValue = document.getElementById('amountType').value;
            if (amountTypeValue === '其他') {
                amount = parseFloat(document.getElementById('customAmount').value);
                if (isNaN(amount) || document.getElementById('customAmount').value.trim() === '') { // Check for empty or non-numeric
                    alert('选择“其他”金额时，请输入有效的数字金额！');
                    return;
                }
            } else {
                amount = parseFloat(amountTypeValue);
            }

            if (!entry_date || !destination) { // Amount validation is now more specific
                alert('请填写有效的日期和选择目的地！');
                return;
            }
            if (isNaN(amount) || amount < 0 ) { // Allow 0 for "油" or "其他" if user explicitly enters it
                 if ( (destination === "油" || destination === "其他") && amountTypeValue === '其他' && document.getElementById('customAmount').value.trim() !== '' && amount >= 0) {
                    // Allow 0 or positive if manually entered for Oil/Other
                 } else {
                    alert('请输入有效的金额（非负数）！');
                    return;
                 }
            }


            if (destination === '其他' && !custom_destination) {
                alert('选择“其他”作为目的地时，请输入自定义目的地名称！');
                return;
            }

            const payload = { entry_date, destination, amount, is_oil_expense };
            if (destination === '其他') {
                payload.custom_destination = custom_destination;
            }

            outputDiv.textContent = '正在添加收入记录...';
            try {
                const response = await fetch(API_BASE_URL_INCOME, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token,
                    },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
                 if (response.ok) {
                    // Reset form fields for next entry, for example:
                    // document.getElementById('customDestination').value = '';
                    // document.getElementById('customAmount').value = '';
                    // handleDestinationChange(); // Reset amount based on current destination
                 }
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('添加收入错误:', error);
            }
        }

        async function getUnsettledIncome() {
            const token = getAuthToken();
            if (!token) return;
            outputDiv.textContent = '正在获取未结算的收入列表...';
            try {
                const response = await fetch(API_BASE_URL_INCOME, {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                    },
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('获取收入列表错误:', error);
            }
        }

        async function executeSettlement() {
            const token = getAuthToken();
            console.log('即将向以下URL发送POST请求 (结算):', API_BASE_URL_SETTLEMENTS, '使用的Token是:', token);
            if (!token) return;

            outputDiv.textContent = '正在执行结算操作...';
            try {
                const response = await fetch(API_BASE_URL_SETTLEMENTS, { 
                    method: 'POST', 
                    headers: {
                        'Authorization': token,
                    },
                });
                const data = await response.json(); 
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;

                if (response.ok) { 
                    alert('结算成功！您可以去查看结算列表或测试总览功能了。');
                } else if (response.status === 400 && data.message === "没有需要结算的收入记录") {
                    alert('提示：当前没有未结算的收入记录可供结算。');
                }
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('执行结算错误:', error);
            }
        }

        async function deleteIncomeEntry() {
            const token = getAuthToken();
            if (!token) return;
            const incomeId = document.getElementById('incomeIdToDelete').value;
            if (!incomeId) {
                alert('请输入要删除的收入记录的 ID！');
                return;
            }
            outputDiv.textContent = `正在删除 ID 为 ${incomeId} 的收入记录...`;
            try {
                const response = await fetch(`${API_BASE_URL_INCOME}/${incomeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token,
                    },
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('删除收入错误:', error);
            }
        }

        async function exportSettlementExcel() {
            const token = getAuthToken();
            if (!token) return;

            const settlementId = document.getElementById('settlementIdToExport').value;
            if (!settlementId) {
                alert('请输入要导出的结算记录的 ID！');
                return;
            }

            outputDiv.textContent = `正在准备导出结算 ID: ${settlementId} 的 Excel 文件...`;
            try {
                const response = await fetch(`${API_BASE_URL_SETTLEMENTS}/${settlementId}/export`, {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                    },
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    const disposition = response.headers.get('content-disposition');
                    let filename = `settlement_${settlementId}_details.xlsx`; 
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) {
                          filename = matches[1].replace(/['"]/g, '');
                        }
                    }
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(downloadUrl);
                    outputDiv.textContent = `结算 ID: ${settlementId} 的 Excel 文件已开始下载。`;
                } else {
                    const data = await response.json(); 
                    outputDiv.textContent = `导出失败 - 状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('导出Excel错误:', error);
            }
        }

        async function changeMyPassword() {
            const token = getAuthToken();
            if (!token) return;

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPasswordUser').value;

            if (!currentPassword || !newPassword) {
                alert('当前密码和新密码均不能为空！');
                return;
            }

            outputDiv.textContent = '正在修改密码...';
            try {
                const response = await fetch(`${API_BASE_URL_AUTH}/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token,
                    },
                    body: JSON.stringify({ currentPassword, newPassword }),
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
                if (response.ok) {
                    alert('密码修改成功！请使用新密码重新登录。');
                    document.getElementById('authToken').value = ''; 
                }
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('修改密码错误:', error);
            }
        }

        // --- 管理员功能区 JavaScript ---
        async function adminGetUserList() {
            const token = getAuthToken();
            if (!token) return;
            console.log('即将向以下URL发送GET请求 (获取用户列表):', `${API_BASE_URL_ADMIN}/users`, '使用的Token是:', token);
            outputDiv.textContent = '正在获取所有用户列表...';
            try {
                const response = await fetch(`${API_BASE_URL_ADMIN}/users`, {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                    },
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('管理员获取用户列表错误:', error);
            }
        }

        function toggleAdminSummaryPeriodInputs() {
            const periodType = document.getElementById('adminPeriodType').value;
            document.getElementById('adminUserSummaryMonthGroup').style.display = (periodType === 'monthly') ? 'block' : 'none';
            document.getElementById('adminUserSummaryWeekGroup').style.display = (periodType === 'weekly') ? 'block' : 'none';
        }

        async function adminGetUserIncomeSummary() {
            const token = getAuthToken();
            if (!token) return;

            const targetUserId = document.getElementById('adminTargetUserIdSummary').value;
            const periodType = document.getElementById('adminPeriodType').value;
            const year = document.getElementById('adminSummaryYear').value;
            const month = document.getElementById('adminSummaryMonth').value;
            const week = document.getElementById('adminSummaryWeek').value;

            if (!targetUserId) {
                alert('请输入目标用户 ID！');
                return;
            }
            if (!year) {
                alert('请输入年份！');
                return;
            }

            let queryString = `periodType=${periodType}&year=${year}`;
            if (periodType === 'monthly') {
                if (!month) {
                    alert('月度统计需要输入月份！');
                    return;
                }
                queryString += `&month=${month}`;
            } else if (periodType === 'weekly') {
                if (!week) {
                    alert('周度统计需要输入周数！');
                    return;
                }
                queryString += `&week=${week}`;
            }
            
            const url = `${API_BASE_URL_ADMIN}/users/${targetUserId}/income-summary?${queryString}`;
            console.log('即将向以下URL发送GET请求 (用户收入统计):', url, '使用的Token是:', token);
            outputDiv.textContent = `正在获取用户 ID: ${targetUserId} 的收入统计...`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                    },
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('管理员获取用户收入统计错误:', error);
            }
        }


        async function adminChangeUserPassword() {
            const token = getAuthToken(); 
            if (!token) return;

            const targetUserId = document.getElementById('targetUserId').value;
            const newPassword = document.getElementById('newPasswordAdmin').value;

            if (!targetUserId || !newPassword) {
                alert('目标用户ID和新密码均不能为空！');
                return;
            }

            outputDiv.textContent = `管理员正在为用户 ID: ${targetUserId} 修改密码...`;
            try {
                const response = await fetch(`${API_BASE_URL_ADMIN}/users/${targetUserId}/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token, 
                    },
                    body: JSON.stringify({ newPassword }),
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
                 if (response.ok) {
                    alert(`用户 ID: ${targetUserId} 的密码已成功修改。`);
                }
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('管理员修改密码错误:', error);
            }
        }

        async function adminBackupDatabase() {
            const token = getAuthToken();
            if (!token) return;
            console.log('即将向以下URL发送POST请求 (备份数据库):', `${API_BASE_URL_ADMIN}/backup-database`, '使用的Token是:', token);
            outputDiv.textContent = '正在创建数据库备份...';
            try {
                const response = await fetch(`${API_BASE_URL_ADMIN}/backup-database`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                    },
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
                if(response.ok) {
                    alert(`数据库备份成功！文件名: ${data.backupFilename}`);
                }
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('创建数据库备份错误:', error);
            }
        }

        async function adminListBackups() {
            const token = getAuthToken();
            if (!token) return;
            console.log('即将向以下URL发送GET请求 (列出备份):', `${API_BASE_URL_ADMIN}/backups`, '使用的Token是:', token);
            outputDiv.textContent = '正在获取备份列表...';
            try {
                const response = await fetch(`${API_BASE_URL_ADMIN}/backups`, {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                    },
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('获取备份列表错误:', error);
            }
        }

        async function adminRestoreDatabase() {
            const token = getAuthToken();
            if (!token) return;

            const filename = document.getElementById('backupFilenameToRestore').value;
            if (!filename) {
                alert('请输入要恢复的备份文件名！');
                return;
            }
            if (!confirm(`确定要从备份文件 "${filename}" 恢复数据库吗？当前数据将被覆盖！恢复后强烈建议重启服务器。`)) {
                return;
            }

            console.log('即将向以下URL发送POST请求 (恢复数据库):', `${API_BASE_URL_ADMIN}/restore-database`, '使用的Token是:', token, '文件名:', filename);
            outputDiv.textContent = `正在从备份文件 "${filename}" 恢复数据库...`;
            try {
                const response = await fetch(`${API_BASE_URL_ADMIN}/restore-database`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token,
                    },
                    body: JSON.stringify({ filename: filename }),
                });
                const data = await response.json();
                outputDiv.textContent = `状态码: ${response.status}\n\n响应内容:\n${JSON.stringify(data, null, 2)}`;
                if(response.ok){
                    alert(data.message); 
                }
            } catch (error) {
                outputDiv.textContent = `请求失败: ${error}`;
                console.error('恢复数据库错误:', error);
            }
        }

    </script>
</body>
</html>
